name: Create Nightly

on:
#  schedule:
#    - cron: '10 10 * * *'
  workflow_dispatch:
#  push:
#    branches: [ Development ]

jobs:
  create-7z:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: Development
          fetch-depth: 0

      - name: Install 7zip
        run: |
          sudo apt-get update
          sudo apt-get install -y p7zip-full

      - name: Get version and date
        id: get_version
        run: |
          if [ ! -f "spruce/spruce" ]; then
            echo "Error: spruce/spruce file not found"
            exit 1
          fi
          VERSION="$(< spruce/spruce)"
          echo "version=${VERSION}-$(date '+%Y%m%d')" >> "$GITHUB_OUTPUT"
          # Get last commit hash and commits, save to file
          {
            echo "Last commit: $(git rev-parse HEAD)"
            echo ""
            echo "Changes in last 24 hours:"
            git log --since="24 hours ago" --pretty=format:'- %s (%an)'
          } > commits_nightly.txt

      - name: Check for commits
        id: check_commits
        run: |
          # Get all commits from last 24 hours
          COMMITS=$(git log --since="24 hours ago" --pretty=format:'- %s (%an)%n')
          if [ -z "$COMMITS" ]; then
            echo "No commits in the last 24 hours"
            exit 1
          fi
          # Write commits to output
          {
            echo "commits<<EOF"
            echo "$COMMITS"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Recombine large files
        run: |
          # Miyoo rootfs
          if ls spruce/flip/miyoo355_rootfs_32.img_part* 1>/dev/null 2>&1; then
            rm -f spruce/flip/miyoo355_rootfs_32.img
            cat spruce/flip/miyoo355_rootfs_32.img_part* > spruce/flip/miyoo355_rootfs_32.img
            rm -f spruce/flip/miyoo355_rootfs_32.img_part*
          fi

          # muOS pixie
          if ls spruce/flip/muOS-pixie-reduced.sqsh-part* 1>/dev/null 2>&1; then
            rm -f spruce/flip/muOS-pixie-reduced.sqsh
            cat spruce/flip/muOS-pixie-reduced.sqsh-part* > spruce/flip/muOS-pixie-reduced.sqsh
            rm -f spruce/flip/muOS-pixie-reduced.sqsh-part*
          fi

          # scummvm libretro core
          if ls RetroArch/.retroarch/cores64/scummvm_libretro.so.part* 1>/dev/null 2>&1; then
            cat RetroArch/.retroarch/cores64/scummvm_libretro.so.part* > RetroArch/.retroarch/cores64/scummvm_libretro.so
            rm -f RetroArch/.retroarch/cores64/scummvm_libretro.so.part*
          fi

      - name: Pull selected PyUI Themes
        run: |
          echo "Cloning PyUI-Themes repo..."
          git clone --depth=1 "https://github.com/spruceUI/PyUI-Themes.git" pyui_themes

          mkdir -p Themes

          echo "Copying selected themes..."

          cp "pyui_themes/PackedThemes/ALEKFULL_NX.7z" Themes/
          cp "pyui_themes/PackedThemes/ALEKFULL_NX_ES.7z" Themes/
          cp "pyui_themes/PackedThemes/ART_BOOK_NEXT.7z" Themes/
          cp "pyui_themes/PackedThemes/Avocado.7z" Themes/
          cp "pyui_themes/PackedThemes/CONSOLED V2.7z" Themes/
          cp "pyui_themes/PackedThemes/Cosy by KyleBing.7z" Themes/
          cp "pyui_themes/PackedThemes/Grape.7z" Themes/
          cp "pyui_themes/PackedThemes/HeyDW's Blue.7z" Themes/
          cp "pyui_themes/PackedThemes/M.7z" Themes/
          cp "pyui_themes/PackedThemes/MINIMAL.7z" Themes/
          cp "pyui_themes/PackedThemes/MinUInspired (logos).7z" Themes/
          cp "pyui_themes/PackedThemes/Pico-8.7z" Themes/
          cp "pyui_themes/PackedThemes/RETRO TV.7z" Themes/
          cp "pyui_themes/PackedThemes/SPRUCE (simple).7z" Themes/
          cp "pyui_themes/PackedThemes/STRIPS.7z" Themes/
          cp "pyui_themes/PackedThemes/SLANTED.7z" Themes/

          echo "Themes copied:"
          ls -lh Themes

          echo "Removing cloned PyUI Themes repo"
          rm -rf pyui_themes

      - name: Create 7z archive
        run: |
          7z a -t7z -m0=lzma2:d=16m -mx=7 -ms=off -mf- "nightly-spruceV${{ steps.get_version.outputs.version }}.7z" * .tmp_update \
            -xr!.git \
            -xr!.github \
            -x!.gitignore \
            -x!.gitattributes \
            -x!create_spruce_release.bat \
            -x!create_spruce_release.sh \
            -x!commits_nightly.txt
          # Add the commits file separately to place it at the root
          7z u "nightly-spruceV${{ steps.get_version.outputs.version }}.7z" commits_nightly.txt

      - name: Generate metadata files
        if: success() && steps.check_commits.outcome == 'success'
        run: |
          # Calculate file info
          CHECKSUM=$(md5sum "nightly-spruceV${{ steps.get_version.outputs.version }}.7z" | cut -d' ' -f1)
          SIZE_MB=$(ls -l --block-size=1M "nightly-spruceV${{ steps.get_version.outputs.version }}.7z" | awk '{print $5}')

          # Create metadata file
          cat > nightly_metadata.txt << EOF
          NIGHTLY_VERSION=${{ steps.get_version.outputs.version }}
          NIGHTLY_CHECKSUM=$CHECKSUM
          NIGHTLY_SIZE_IN_MB=$SIZE_MB
          EOF

          echo "Generated metadata:"
          cat nightly_metadata.txt

      - name: Upload nightly build artifact
        if: success() && steps.check_commits.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: nightly-spruceV${{ steps.get_version.outputs.version }}
          path: |
            nightly-spruceV${{ steps.get_version.outputs.version }}.7z
            nightly_metadata.txt
            commits_nightly.txt
          retention-days: 30

      - name: Update OTA files
        if: success() && steps.check_commits.outcome == 'success'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Clone both repositories
          git clone https://github.com/spruceUI/spruceui.github.io.git ota_repo
          git clone https://github.com/spruceUI/spruceSource.git source_repo

          # Calculate file info
          CHECKSUM=$(md5sum "nightly-spruceV${{ steps.get_version.outputs.version }}.7z" | cut -d' ' -f1)
          SIZE_MB=$(ls -l --block-size=1M "nightly-spruceV${{ steps.get_version.outputs.version }}.7z" | awk '{print $5}')

          # Function to update OTA file
          update_ota_file() {
            local file="$1"
            local content
            content=$(cat "$file")

            echo "$content" | grep -v "^NIGHTLY_" > "$file"
            echo "NIGHTLY_VERSION=${{ steps.get_version.outputs.version }}" >> "$file"
            echo "NIGHTLY_CHECKSUM=$CHECKSUM" >> "$file"
            echo "NIGHTLY_SIZE_IN_MB=$SIZE_MB" >> "$file"
            # Note: Artifacts are downloaded via GitHub Actions UI, not direct links
            echo "NIGHTLY_LINK=https://github.com/CatalyticArkun/spruceOS/actions" >> "$file"
            echo "NIGHTLY_INFO=Nightly build ${{ steps.get_version.outputs.version }} - Download from GitHub Actions artifacts" >> "$file"
          }

          # Update both OTA files
          update_ota_file "ota_repo/OTA/spruce"
          update_ota_file "source_repo/OTA/spruce"

          # Update primary OTA repo
          cd ota_repo
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add OTA/spruce
          git commit -m "Update nightly release to ${{ steps.get_version.outputs.version }}"
          git push https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/spruceUI/spruceui.github.io.git main

          # Update backup OTA repo
          cd ../source_repo
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add OTA/spruce
          git commit -m "Update nightly release to ${{ steps.get_version.outputs.version }}"
          git push https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/spruceUI/spruceSource.git main





